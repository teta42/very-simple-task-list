<html>
<head>
  <link href="https://fonts.googleapis.com/css2?family=K2D&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'K2D', sans-serif;
    }
  </style>
</head>
<body>
  <input type="text" id="taskInput">
  {% csrf_token %}
  <button onclick="sendTask()">Отправить</button>
  <div id="taskList"></div>

  <script>
    function sendTask() {
      let taskText = document.getElementById('taskInput').value;
      fetch('http://127.0.0.1:8000/options/new_task', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ text: taskText })
      })
      .then(response => response.json())
      .then(data => {
        document.getElementById('taskInput').value = '';
      });
    }

    window.onload = function() {
      fetch('http://127.0.0.1:8000/options/list_task')
      .then(response => response.json())
      .then(data => {
        let taskList = document.getElementById('taskList');
        let reversedKeys = Object.keys(data).reverse();  // Reversing the keys
        for (let key of reversedKeys) {
          let task = data[key];
          let taskLine = document.createElement('div');
          taskLine.textContent = `${task.status}: ${task.text} - ${task.date}`;
          let changeStatusButton = document.createElement('button');
          changeStatusButton.textContent = 'Change Status';
          changeStatusButton.onclick = function() {
            changeStatus(key, task.id); // Passing the task identifier to the changeStatus function
          };
          let deleteButton = document.createElement('button');  // Creating a delete button
          deleteButton.textContent = 'Delete';  // Button text
          deleteButton.onclick = function() {
            deleteTask(key, task.id);  // Calling the deleteTask function with the task identifier
          };
          taskLine.appendChild(changeStatusButton);
          taskLine.appendChild(deleteButton);  // Adding the delete button to the task
          taskList.appendChild(taskLine);
        }
        // Adding the 'Exit' button
        let exitButton = document.createElement('button');
        exitButton.textContent = 'Exit';
        exitButton.style.position = 'absolute';
        exitButton.style.top = '10px';
        exitButton.style.right = '10px';
        exitButton.onclick = function() {
          fetch('http://127.0.0.1:8000/account/logout/', {
            method: 'POST',
            headers: {
              'X-CSRFToken': getCookie('csrftoken')
            }
          })
          .then(response => response.json())
          .then(data => {
              if (data.status === 'ok') {
                window.location.href = 'http://127.0.0.1:8000/';
              }
            });
        };
        document.body.appendChild(exitButton);
        let newButton = document.createElement('button');
        newButton.textContent = 'Удалить аккаунт';  // Текст кнопки
        newButton.style.position = 'absolute';  // Позиционирование кнопки
        newButton.style.top = '50%';  // Выравнивание по вертикали
        newButton.style.right = '10px';  // Выравнивание по правому краю
    
        newButton.onclick = function() {
          // Отправка POST-запроса
          fetch('http://127.0.0.1:8000/account/delete/', {
            method: 'DELETE',
            headers: {
              'X-CSRFToken': getCookie('csrftoken')
            }
          })
          .then(response => response.json())
          .then(data => {
            if (data.status === 'ok') {
              window.location.href = 'http://127.0.0.1:8000/';
            }
          });
        };
        document.body.appendChild(newButton);  // Добавление новой кнопки на страницу
        
        let changeAccountButton = document.createElement('button');
        changeAccountButton.textContent = 'Изменить аккаунт';  // Текст кнопки
        changeAccountButton.style.position = 'fixed';  // Позиционирование кнопки
        changeAccountButton.style.bottom = '10px';  // Выравнивание по нижнему краю
        changeAccountButton.style.right = '10px';  // Выравнивание по правому краю
    
        changeAccountButton.onclick = function() {
          window.location.href = 'http://127.0.0.1:8000/account/change/';
        };
        document.body.appendChild(changeAccountButton);  // Добавление новой кнопки на страницу
      });
    };
    
    
    function changeStatus(taskId) {
      let statusOptions = ['new', 'resolved', 'unresolved', 'abandoned'];
      let statusSelection = 'resolved'; // Выбор статуса происходит без поля ввода
      if (statusOptions.includes(statusSelection)) {
        let statusList = document.createElement('div');
        statusOptions.forEach(option => {
          let checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.value = option;
          checkbox.id = option;
          let label = document.createElement('label');
          label.htmlFor = option;
          label.appendChild(document.createTextNode(option));
          statusList.appendChild(checkbox);
          statusList.appendChild(label);
          statusList.appendChild(document.createElement('br'));
        });
        let confirmButton = document.createElement('button');
        confirmButton.textContent = 'Подтвердить';
        confirmButton.onclick = function() {
          let selectedStatus = Array.from(statusList.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
          if (selectedStatus.length > 0) {
            fetch('http://127.0.0.1:8000/options/change_task', {
              method: 'PUT',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
              },
              body: JSON.stringify({ id: taskId, status: selectedStatus[0] })
            })
            .then(response => response.json())
            .then(data => {
              // Логика обновления отображаемых данных после изменения статуса
            });
            dialog.close(); // Закрыть диалоговое окно после подтверждения
          } else {
            alert('Пожалуйста, выберите статус.');
          }
        };
        statusList.appendChild(confirmButton);
    
        // Создать диалоговое окно для отображения списка статусов
        let dialog = document.createElement('dialog');
        dialog.appendChild(statusList);
        document.body.appendChild(dialog);
        dialog.showModal();
    
        // Примечание: dialog.close() вызывается в обработчике события кнопки подтверждения
      }
    }
    
    function deleteTask(taskId) {
      fetch('http://127.0.0.1:8000/options/delete_task', {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ taskId: taskId })
      })
      .then(response => response.json())
      .then(data => {
        // Логика обновления отображаемых данных после удаления задачи
      });
    }
    

    // Function to get the CSRF token from the cookie
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
              const cookie = cookies[i].trim();
              // Does this cookie string begin with the name we want?
              if (cookie.substring(0, name.length + 1) === (name + '=')) {
                  cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                  break;
              }
          }
      }
      return cookieValue;
  }
  </script>
</body>
</html>